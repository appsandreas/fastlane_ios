default_platform(:ios)

platform :ios do
    desc "Build and Release the iOS application"
    lane :build do
        setup_ci if ENV['CI']

        app_store_connect_api_key(
            key_id: ENV["APPLE_KEY_ID"],
            issuer_id: ENV["APPLE_ISSUER_ID"],
            key_content: ENV["APPLE_KEY_CONTENT"],
            is_key_content_base64: true,
            in_house: false #boolean value if team is Enterprise or not
        )
        
        match(
            git_url: "git@github.com:appsandreas/fastlane_sert_ios.git",
            type: "appstore"
        )

        cert
        sigh(force: true)

        disable_automatic_code_signing

        profile_path = lane_context[SharedValues::SIGH_PROFILE_PATH]
        UI.message("Путь к профилю подписи: #{profile_path}")

        profile_name = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING][app_identifier]
        UI.message("Путь к профилю подписи: #{profile_name}")

        profile_uuid = lane_context[SharedValues::SIGH_UUID] # UUID профиля подписи
        UI.message("Путь к профилю подписи: #{profile_uuid}")

        # Обновление проекта с новым профилем
        update_project_provisioning(
            profile: profile_path, # Путь к загруженному профилю подписи
            target_filter: '.*', # Фильтр целей проекта, к которым будет применена подпись
            build_configuration: 'Release' # Настройка сборки, для которой будет использоваться профиль
        )

        cocoapods(
          clean_install: true,
        )

        increment_build_number

        gym(
            clean: true,
            scheme: ENV["APP_SCHEME"],
            export_method: "app-store",
            export_xcargs: "-allowProvisioningUpdates"
        )
        
        upload_to_app_store(
            skip_metadata: true, # Пропустить загрузку метаданных
            skip_screenshots: true, # Пропустить загрузку скриншотов
            force: true # Пропустить подтверждение перед загрузкой
        )
    end
end
